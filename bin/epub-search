require 'pathname'
require 'yaml'
require 'thor'
require 'epub/search'

Class.new(Thor) {
  APP_DIR = File.expand_path('../../app', __FILE__)
  DEFAULT_CONFIG = {
    :config_path => File.join(Dir.home, '.epub-search/config.yaml'),
    :db_dir      => File.join(Dir.home, '.epub-search/db')
  }
  Dir["#{APP_DIR}/*.rb"].each do |path|
    require path
  end

  desc 'init', 'setup database'
  method_option :db_dir, :banner  => 'DB_DIR',
                         :default => File.join(Dir.home, '.epub-search/db'),
                         :desc    => 'path to database directory'
  def init(db_dir=config[:db_dir])
    Init.new(db_dir).run
  end

  desc 'add FILE', 'add FILE to database'
  def add(file)
    Add.new(File.join(config[:db_dir], Init::FILE_NAME), file).run
  end

  private

  def config
    @config ||=
      File.file?(DEFAULT_CONFIG[:config_path]) ? YAML.parse_file(DEFAULT_CONFIG[:config_path])
                                               : DEFAULT_CONFIG
  end
}.start
